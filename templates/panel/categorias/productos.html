{% extends 'panel/base_panel.html' %}

{% block title %}Gestionar Productos - {{ categoria.nombre }}{% endblock %}

{% block panel_content %}
<div class="panel-header">
    <div>
        <a href="{% url 'panel:categorias' %}" class="btn btn-outline btn-sm">← Volver</a>
        <h1 class="panel-title" style="margin-top: 0.5rem;">Gestionar Productos: {{ categoria.nombre }}</h1>
    </div>
</div>

<div class="filter-bar">
    <form method="get" style="display: flex; gap: 1rem; width: 100%;">
        <input type="text" name="q" class="form-control" placeholder="Buscar por nombre o SKU..."
            value="{{ busqueda }}">
        <button type="submit" class="btn btn-primary">Buscar</button>
        {% if busqueda %}
        <a href="{% url 'panel:categoria_productos' categoria.id %}" class="btn btn-outline">Limpiar</a>
        {% endif %}
    </form>
</div>

<div class="panel-form">
    <form method="post" id="bulkForm">
        {% csrf_token %}

        <div class="bulk-actions"
            style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; background: #f8f9fa; padding: 1rem; border-radius: 8px;">
            <strong>Acciones en lote:</strong>
            <button type="submit" name="action" value="add_selected" class="btn btn-success">
                + Agregar Seleccionados
            </button>
            <button type="submit" name="action" value="remove_selected" class="btn btn-danger">
                - Quitar Seleccionados
            </button>
        </div>

        <div class="panel-table">
            <table>
                <thead>
                    <tr>
                        <th width="40" style="text-align: center;">
                            <input type="checkbox" id="selectAll">
                        </th>
                        <th>SKU</th>
                        <th>Producto</th>
                        <th>Estado en Categoría</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr class="{% if producto.id in productos_en_categoria_ids %}row-highlight{% endif %}">
                        <td style="text-align: center;">
                            <input type="checkbox" name="productos" value="{{ producto.id }}" class="prod-check">
                        </td>
                        <td>{{ producto.sku }}</td>
                        <td>{{ producto.nombre }}</td>
                        <td>
                            {% if producto.id in productos_en_categoria_ids %}
                            <span class="badge badge-success">✅ Asignado</span>
                            {% else %}
                            <span class="badge badge-gray">No Asignado</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem;">No se encontraron productos.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>

{% if page_obj.has_other_pages %}
<div class="pagination" style="margin-top: 1rem;">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}&q={{ busqueda }}">‹</a>
    {% endif %}
    <span class="current">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}&q={{ busqueda }}">›</a>
    {% endif %}
</div>
{% endif %}

<style>
    .row-highlight {
        background-color: #f0fff4;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-success {
        background: #d4edda;
        color: #155724;
    }

    .badge-gray {
        background: #e9ecef;
        color: #495057;
    }
</style>

<script>
    document.getElementById('selectAll').addEventListener('change', function () {
        const checkboxes = document.querySelectorAll('.prod-check');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
</script>
{% endblock %}